---
## Front matter
title: "Лабораторная работа №9"
subtitle: "Настройка POP3/IMAP сервера"
author: "Андреева Софья Владимировна"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: false # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и простейшему конфигурированию POP3/IMAP-сервера.

# Задание

1. Установите на виртуальной машине server Dovecot и Telnet для дальнейшей проверки корректности работы почтового сервера.
2. Настройте Dovecot.
3. Установите на виртуальной машине client программу для чтения почты Evolution и настройте её для манипуляций с почтой вашего пользователя. Проверьте корректность работы почтового сервера как с виртуальной машины server, так и с виртуальной машины client.
4. Измените скрипт для Vagrant, фиксирующий действия по установке и настройке Postfix и Dovecote во внутреннем окружении виртуальной машины server, создайте скрипт для Vagrant, фиксирующий действия по установке Evolution во внутреннем окружении виртуальной машины client. Соответствующим образом внесите изменения в Vagrantfile.

# Выполнение лабораторной работы

## Установка Dovecot

Загрузим нашу операционную систему и перейдем в рабочий каталог с проектом:
```
cd /var/tmp/svandreeva/vagrant
```
Затем запустим виртуальную машину server:
```
make server-up
```

Откроем терминал и, перейдя в режим суперпользователя, установим необходимые для работы пакеты(рис. @fig:001):

![Установка Dovecot](image/1.png){#fig:001 width=70%}

На основе существующего файла описания службы ssh создадим файл с собственным описанием, просмотрим его содержимое

## Настройка dovecot

В конфигурационном файле /etc/dovecot/dovecot.conf пропишем список почтовых протоколов, по которым разрешено работать Dovecot(рис. @fig:002):

![Редактирование файла /etc/dovecot/dovecot.conf](image/2.png){#fig:002 width=70%}

В конфигурационном файле /etc/dovecot/conf.d/10-auth.conf укажем метод аутентификации plain(@fig:003):

![Редактирование файла /etc/dovecot/conf.d/10-auth.conf](image/3.png){#fig:003 width=70%}

В конфигурационном файле /etc/dovecot/conf.d/auth-system.conf.ext проверим, что для поиска пользователей и их паролей используется pam и файл passwd(рис. @fig:004, @fig:005):

![Просмотр файла /etc/dovecot/conf.d/auth-system.conf.ext](image/4.png){#fig:004 width=70%}

![Просмотр файла /etc/dovecot/conf.d/auth-system.conf.ext](image/5.png){#fig:005 width=70%}

В конфигурационном файле /etc/dovecot/conf.d/10-mail.conf настроим месторасположение почтовых ящиков пользователей(рис. @fig:006):

![Редактирование файла /etc/dovecot/conf.d/10-mail.conf](image/6.png){#fig:006 width=70%}

В Postfix зададим каталог для доставки почты, затем сконфигурируем межсетевой экран, разрешив работать службам  протоколов POP3 и IMAP, восстановим контекст безопасности SELinux, а затем перезапустим Postfix и запустим Dovecot(@fig:007):

![Конфигурация Postfix, межсетевого экрана для работы с POP3 и IMAP и запуск Dovecot](image/7.png){#fig:007 width=70%}


## Проверка работы Dovecot

На дополнительном терминале виртуальной машины server запустим мониторинг
работы почтовой службы с помощью команды:

```
tail -f /var/log/maillog
```

На терминале сервера просмотрим имеющуюся почту и mailbox пользователя на сервере(@fig:008):

![Просмотр почты и mailbox](image/8.png){#fig:008 width=70%}

На виртуальной машине client войдем под своим пользователем и откроем терминал. Перейдем в режим суперпользователя и установим почтовый клиент(@fig:009):

![Установка почтового клиента evolution на виртуальную машину client](image/9.png){#fig:009 width=70%}

Запустим и настроим почтовый клиент Evolution. 

В окне настройки учётной записи почты укажим имя, адрес почты svandreeva@svandreeva.net, введите пароль нашего пользователя(рис. @fig:010):

![Настройка учетной записи почтового клиента](image/10.png){#fig:010 width=70%}

В качестве IMAP-сервера для входящих сообщений и SMTP-сервера для исходящих
сообщений пропишем mail.svandreeva.net, в качестве пользователя для входящих
и исходящих сообщений укажем svandreeva, также укажем номера портов: для IMAP -- порт 143, для SMTP -- порт 25, и укажем настройки SSL и метода аутентификации: для IMAP -- STARTTLS, аутентификация по обычному паролю, для SMTP -- без аутентификации, аутентификация -- «Без аутентификации»(рис. @fig:011, @fig:012):

![Настройка IMAP-сервера для входящих сообщений](image/11.png){#fig:011 width=70%}

![Настройка SMTP-сервера для исходящих сообщений](image/12.png){#fig:012 width=70%}

Из почтового клиента отправим себе два тестовых письма, убедимся, что они
доставлены(рис. @fig:013):

![Проверка получения писем на почтовом клиенте](image/13.png){#fig:013 width=70%}

Посмотрим, какие сообщения выдаются при мониторинге почтовой службы на сервере, а также при использовании doveadm и mail(рис. @fig:014, @fig:015):

![Просмотр мониторинга почтовой службы на сервере](image/14.png){#fig:014 width=70%}

![Просмотр информации о почтовой службе с помощью doveadm и mail](image/15.png){#fig:015 width=70%}

При мониторинге почтовой службы на сервере можно увидеть, что происходит подключение неизвестному домену, затем указывается информация о пользователе с почтового клиенте и происходит получение письма адресом svandreeva@svandreeva.net от себя самого, и таким образом получено два письма. При использовании mail теперь показываются два полученных письма с указанием имени отправителя, даты и времени, длины и темы письма. При использовании doveadm всё также показана директория mailbox.

Проверим работу почтовой службы, используя на сервере протокол Telnet. Для этого подключимся с помощью протокола Telnet к почтовому серверу по протоколу POP3
(через порт 110), введем свой логин для подключения и пароль. А затем с помощью команды list получим список писем; с помощью команды retr 1 получим первое письмо из списка; с помощью команды dele 2 удалим второе письмо из списка; с помощью команды quit завершите сеанс работы с telnet(рис. @fig:016):

![Проверка почтовой службы с помощью протокола Telnet](image/16.png){#fig:016 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перейдем в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/. В соответствующие подкаталоги поместим конфигурационные файлы Doveco, а также заменим конфигурационный файл Postfix(рис. @fig:017)

![Создание окружения для внесения изменений в настройки окружающей среды](image/17.png){#fig:017 width=70%}

Внесием изменения в файл /vagrant/provision/server/mail.sh, добавив в него
строки по установке Dovecot и Telnet; по настройке межсетевого экрана; по настройке Postfix в части задания месторасположения почтового ящика; по перезапуску Postfix и запуску Dovecot(@fig:018):

![Изменение файла /vagrant/provision/server/mail.sh](image/18.png){#fig:018 width=70%}

На виртуальной машине client в каталоге /vagrant/provision/client скорректируем файл mail.sh, прописав в нём команду для установки почтового клиента evolution(@fig:019):

![Изменение файла /vagrant/provision/client/mail.sh](image/19.png){#fig:019 width=70%}

# Контрольные вопросы

1. За что отвечает протокол SMTP?

У протокола две главные задачи:

- Проверка корректности настроек системы и предоставление «разрешения» на отправку email-сообщения для определенного устройства.
- Отправка исходящего сообщения на заданный адрес электронной почты и подтверждение успешной доставки. Если сообщение доставить не удается, отправитель получает соответствующее извещение.
  
2. За что отвечает протокол IMAP?

Протокол IMAP (Internet Message Access Protocol) отвечает за доступ к почтовому ящику, позволяя пользователям получать и управлять электронными сообщениями на сервере

3. За что отвечает протокол POP3?

Протокол POP3 (Post Office Protocol version 3) отвечает за получение электронной почты с почтового сервера на устройство пользователя.

4. В чём назначение Dovecot?

Dovecot — агент доставки почты (MDA) по протоколам POP3 и IMAP с возможностью обеспечения безопасности и надёжности за счёт использования протокола TLS. 

5. В каких файлах обычно находятся настройки работы Dovecot? За что отвечает каждый из файлов?

Конфигурация Dovecot располагается в файле /etc/dovecot/dovecot.conf и в файлах каталога /etc/dovecot/conf.d. Файл сертификатов безопасности Dovecot располагается в каталоге /etc/pki/dovecot.

6. В чём назначение Postfix?

Postfix - это почтовый агент (MTA), используемый для маршрутизации и доставки электронной почты.

7. Какие методы аутентификации пользователей можно использовать в Dovecot и в чём их отличие?

В Dovecot можно использовать методы аутентификации, такие как Plain, CRAM-MD5, Digest-MD5, NTLM и другие. Они отличаются способом передачи учётных данных и уровнем безопасности. Plain передаёт данные в открытом виде, в то время как CRAM-MD5 и Digest-MD5 используют хэширование для безопасной передачи паролей. NTLM - это протокол Windows для аутентификации.

8. Приведите пример заголовка письма с пояснениями его полей.

В заголовке письма указывается имя отправителя, дата отправки, размер письма и тема сообщения(@fig:020):

![Просмотр информации о письме с помощью mail](image/15.png){#fig:020 width=70%}

9. Приведите примеры использования команд для работы с почтовыми протоколами через терминал (например через telnet).

Привожу пример просмотра писем, их содержания и удаления с помощью telnet(@fig:021):

![Команды для работы с почтовыми протоколами](image/16.png){#fig:021 width=70%}

# Выводы

В результате выполнения данной работы были приобретены практические навыки по установке и простейшему конфигурированию POP3/IMAP-сервера.


